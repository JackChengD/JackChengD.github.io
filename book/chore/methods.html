<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>重构手法 | Jack</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="describe myself">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.6306d817.js" as="script"><link rel="preload" href="/assets/js/2.e437a02e.js" as="script"><link rel="preload" href="/assets/js/26.7e911e6f.js" as="script"><link rel="prefetch" href="/assets/js/10.8a433c9e.js"><link rel="prefetch" href="/assets/js/11.f0843645.js"><link rel="prefetch" href="/assets/js/12.26bda8c0.js"><link rel="prefetch" href="/assets/js/13.7e2b6ddb.js"><link rel="prefetch" href="/assets/js/14.7ef3490f.js"><link rel="prefetch" href="/assets/js/15.518bba56.js"><link rel="prefetch" href="/assets/js/16.c4f0feca.js"><link rel="prefetch" href="/assets/js/17.e2713cf6.js"><link rel="prefetch" href="/assets/js/18.9209155d.js"><link rel="prefetch" href="/assets/js/19.11b3dcb6.js"><link rel="prefetch" href="/assets/js/20.01a9f500.js"><link rel="prefetch" href="/assets/js/21.9c907d9e.js"><link rel="prefetch" href="/assets/js/22.dad1eec5.js"><link rel="prefetch" href="/assets/js/23.833e58e0.js"><link rel="prefetch" href="/assets/js/24.e3e81d50.js"><link rel="prefetch" href="/assets/js/25.d1b69dfe.js"><link rel="prefetch" href="/assets/js/27.bbe1ed06.js"><link rel="prefetch" href="/assets/js/28.9a0fbf54.js"><link rel="prefetch" href="/assets/js/29.eed0bc39.js"><link rel="prefetch" href="/assets/js/3.36cdcdc1.js"><link rel="prefetch" href="/assets/js/30.2e9112b3.js"><link rel="prefetch" href="/assets/js/31.a2c6fd7f.js"><link rel="prefetch" href="/assets/js/32.69cd2bc7.js"><link rel="prefetch" href="/assets/js/33.5c5125cf.js"><link rel="prefetch" href="/assets/js/34.8bb5a16c.js"><link rel="prefetch" href="/assets/js/35.573ce1d8.js"><link rel="prefetch" href="/assets/js/36.0784e80b.js"><link rel="prefetch" href="/assets/js/37.fd9914cd.js"><link rel="prefetch" href="/assets/js/38.b2c2d84b.js"><link rel="prefetch" href="/assets/js/39.d8d57906.js"><link rel="prefetch" href="/assets/js/4.e05c873c.js"><link rel="prefetch" href="/assets/js/40.3d6495d9.js"><link rel="prefetch" href="/assets/js/41.c0584e37.js"><link rel="prefetch" href="/assets/js/42.f61d9235.js"><link rel="prefetch" href="/assets/js/43.95774641.js"><link rel="prefetch" href="/assets/js/44.eb6bdd03.js"><link rel="prefetch" href="/assets/js/45.9a52ad9e.js"><link rel="prefetch" href="/assets/js/46.439442af.js"><link rel="prefetch" href="/assets/js/47.978ad039.js"><link rel="prefetch" href="/assets/js/48.275397b7.js"><link rel="prefetch" href="/assets/js/49.74506d71.js"><link rel="prefetch" href="/assets/js/5.f3e6ed41.js"><link rel="prefetch" href="/assets/js/50.00649510.js"><link rel="prefetch" href="/assets/js/51.4f737440.js"><link rel="prefetch" href="/assets/js/52.2da40936.js"><link rel="prefetch" href="/assets/js/53.2d6ebf26.js"><link rel="prefetch" href="/assets/js/54.5e5c44bd.js"><link rel="prefetch" href="/assets/js/55.c23e9a0d.js"><link rel="prefetch" href="/assets/js/56.ad1ec803.js"><link rel="prefetch" href="/assets/js/57.df3621c0.js"><link rel="prefetch" href="/assets/js/58.ddb4c2de.js"><link rel="prefetch" href="/assets/js/59.72395464.js"><link rel="prefetch" href="/assets/js/6.498ab014.js"><link rel="prefetch" href="/assets/js/60.ebc46d45.js"><link rel="prefetch" href="/assets/js/61.fa0a14ad.js"><link rel="prefetch" href="/assets/js/62.11f4e335.js"><link rel="prefetch" href="/assets/js/63.bcaf4292.js"><link rel="prefetch" href="/assets/js/64.5cf224fe.js"><link rel="prefetch" href="/assets/js/65.34159c35.js"><link rel="prefetch" href="/assets/js/66.1f4bd862.js"><link rel="prefetch" href="/assets/js/67.e467befa.js"><link rel="prefetch" href="/assets/js/68.9632ce99.js"><link rel="prefetch" href="/assets/js/69.504e179e.js"><link rel="prefetch" href="/assets/js/7.3f5168c2.js"><link rel="prefetch" href="/assets/js/70.40166737.js"><link rel="prefetch" href="/assets/js/71.2162e1c6.js"><link rel="prefetch" href="/assets/js/8.c39887e6.js"><link rel="prefetch" href="/assets/js/9.9a7354f4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jack</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/work/" class="nav-link">
  工作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/chore/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li><li class="dropdown-item"><!----> <a href="/book/clean-code/" class="nav-link">
  代码整洁之道
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  leetcode
</a></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于作者
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/work/" class="nav-link">
  工作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/chore/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li><li class="dropdown-item"><!----> <a href="/book/clean-code/" class="nav-link">
  代码整洁之道
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  leetcode
</a></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于作者
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/book/chore/ " class="sidebar-heading clickable open"><span>重构改善既有代码的设计</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/chore/what.html" class="sidebar-link">什么是重构</a></li><li><a href="/book/chore/why.html" class="sidebar-link">为什么要重构</a></li><li><a href="/book/chore/when.html" class="sidebar-link">什么时候要重构</a></li><li><a href="/book/chore/bad-smell.html" class="sidebar-link">代码的怪味道</a></li><li><a href="/book/chore/methods.html" aria-current="page" class="active sidebar-link">重构手法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/chore/methods.html#提炼函数-extract-function" class="sidebar-link">提炼函数(Extract Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#以函数调用取代内联代码-replace-inline-code-with-function-call" class="sidebar-link">以函数调用取代内联代码(Replace Inline Code with Function Call)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#查询取代临时变量-replace-temp-with-query" class="sidebar-link">查询取代临时变量(Replace Temp with Query)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将查询函数和修改函数分离-separate-query-from-modifier" class="sidebar-link">将查询函数和修改函数分离(Separate Query from Modifier)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#内联变量-inline-variable" class="sidebar-link">内联变量(Inline Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#改变函数声明-change-function-declaration" class="sidebar-link">改变函数声明(Change Function Declaration)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#内联函数-inline-function" class="sidebar-link">内联函数(Inline Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移语句到调用者-move-statements-to-callers" class="sidebar-link">搬移语句到调用者(Move Statements to Callers)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#变量改名-rename-variable" class="sidebar-link">变量改名(Rename Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装变量-encapsulate-variable" class="sidebar-link">封装变量(Encapsulate Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装记录-encapsulate-record" class="sidebar-link">封装记录(Encapsulate Record)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装集合-encapsulate-collection" class="sidebar-link">封装集合(Encapsulate Collection)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#移除设值函数-remove-setting-mehotd" class="sidebar-link">移除设值函数(Remove Setting Mehotd)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#以对象取代基本类型-replace-primitive-with-object" class="sidebar-link">以对象取代基本类型(Replace Primitive with Object)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将引用对象改为值对象-change-reference-to-value" class="sidebar-link">将引用对象改为值对象(Change Reference to Value)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将值对象改为引用对象-change-value-to-reference" class="sidebar-link">将值对象改为引用对象(Change Value to Reference)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#提炼类-extract-class" class="sidebar-link">提炼类(Extract Class)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移字段-move-field" class="sidebar-link">搬移字段(Move Field)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移函数-move-function" class="sidebar-link">搬移函数(Move Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#引入断言-intraduce-assertion" class="sidebar-link">引入断言(Intraduce Assertion)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#移动语句-slide-statements" class="sidebar-link">移动语句(Slide Statements)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#拆分变量-split-variable" class="sidebar-link">拆分变量(Split Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#内联类-inline-class" class="sidebar-link">内联类(Inline Class)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#隐藏委托关系-hide-delegate" class="sidebar-link">隐藏委托关系(Hide Delegate)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#移除中间人-remove-middle-man" class="sidebar-link">移除中间人(Remove Middle Man)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#替换算法-substitute-algorithm" class="sidebar-link">替换算法(Substitute Algorithm)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移语句到函数-move-statements-into-function" class="sidebar-link">搬移语句到函数(Move Statements into Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移语句到调用者-move-statements-to-callers-2" class="sidebar-link">搬移语句到调用者(Move Statements to Callers)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#以管道取代循环-replace-loop-with-pipeline" class="sidebar-link">以管道取代循环(Replace Loop with Pipeline)</a></li></ul></li><li><a href="/book/chore/good-words.html" class="sidebar-link">好句子</a></li><li><a href="/book/chore/from.html" class="sidebar-link">源自</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/book/clean-code" class="sidebar-heading clickable"><span>代码整洁之道</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/clean-code/function.html" class="sidebar-link">函数</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="重构手法"><a href="#重构手法" class="header-anchor">#</a> 重构手法</h1> <h2 id="提炼函数-extract-function"><a href="#提炼函数-extract-function" class="header-anchor">#</a> 提炼函数(Extract Function)</h2> <p>曾用名：提炼函数<br>
反向重构：内联函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">printOwing</span><span class="token punctuation">(</span><span class="token parameter">invoice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printBanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> outstanding <span class="token operator">=</span> <span class="token function">calculateOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// print details</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>invoice<span class="token punctuation">.</span>customer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">amount：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outstanding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">printOwing</span><span class="token punctuation">(</span><span class="token parameter">invoice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printBanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> outstanding <span class="token operator">=</span> <span class="token function">calculateOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printDetails</span><span class="token punctuation">(</span>outstanding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">printDetails</span><span class="token punctuation">(</span><span class="token parameter">outstanding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>invoice<span class="token punctuation">.</span>customer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">amount:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outstanding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机"><a href="#动机" class="header-anchor">#</a> 动机</h3> <p>1、函数过长；<br>
2、代码类似；<br>
3、明确代码用意。</p> <h3 id="做法"><a href="#做法" class="header-anchor">#</a> 做法</h3> <p>1、创建一个新函数（以它“做什么”来命名，而不是以它“怎么做”命名）；<br>
2、将待提炼的代码从源函数复制到新建的目标函数中；<br>
3、仔细检查提炼出的代码，看看其中是否引用了作用域限于源函数、在提炼出的新函数中访问不到的变量。若是，以参数的形式将它们传递给新函数；<br>
4、所有变量都处理完之后，编译；<br>
5、在源函数中，将被提炼代码段替换为对目标函数的调用；<br>
6、测试；<br>
7、查看其他代码是否有与被提炼的代码段相同或相似之处。如果有，考虑使用<a href="#%E4%BB%A5%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8F%96%E4%BB%A3%E5%86%85%E8%81%94%E4%BB%A3%E7%A0%81-replace-inline-code-with-function-call">以函数调用取代内联代码</a>。</p> <h2 id="以函数调用取代内联代码-replace-inline-code-with-function-call"><a href="#以函数调用取代内联代码-replace-inline-code-with-function-call" class="header-anchor">#</a> 以函数调用取代内联代码(Replace Inline Code with Function Call)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> appliesToMass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> s <span class="token keyword">of</span> states<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token string">&quot;MA&quot;</span><span class="token punctuation">)</span> appliesToMass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  appliesToMass <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;MA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-2"><a href="#动机-2" class="header-anchor">#</a> 动机</h3> <p>1、善用函数可以将相关的行为打包起来；<br>
2、配合一些库函数使用，会使本手法效果更佳。</p> <h3 id="做法-2"><a href="#做法-2" class="header-anchor">#</a> 做法</h3> <p>1、将内联代码替代为对一个既有函数的调用；<br>
2、测试。</p> <h2 id="查询取代临时变量-replace-temp-with-query"><a href="#查询取代临时变量-replace-temp-with-query" class="header-anchor">#</a> 查询取代临时变量(Replace Temp with Query)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">get</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> basePrice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_quantity <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_itemPrice<span class="token punctuation">;</span>
    <span class="token keyword">var</span> discountFactor <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> discountFactor <span class="token operator">-=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> basePrice <span class="token operator">*</span> discountFactor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">get</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discountFactor<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  
  <span class="token keyword">get</span> <span class="token function">basePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_quantity <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_itemPrice<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">discountFactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> discountFactor <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> discountFactor <span class="token operator">-=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> discountFactor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-3"><a href="#动机-3" class="header-anchor">#</a> 动机</h3> <p>1、避免在多个函数中重复编写计算逻辑；<br>
2、处理某些类型的临时变量；那些只被计算一次且之后不再被修改的变量。</p> <h3 id="做法-3"><a href="#做法-3" class="header-anchor">#</a> 做法</h3> <p>1、检查变量在使用前是否已经完全计算完毕，检查计算它的那段代码是否每次都能得到一样的值；<br>
2、如果变量目前不是只读的，但是可以改造成只读变量，那就先改造它；<br>
3、测试；<br>
4、将为变量赋值的代码段提炼成函数；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果变量和函数不能使用同样的名字，那么先为函数取个临时的名字。<br>
确保待提炼函数没有副作用。若有，先应用<a href="#%E5%B0%86%E6%9F%A5%E8%AF%A2%E5%87%BD%E6%95%B0%E5%92%8C%E4%BF%AE%E6%94%B9%E5%87%BD%E6%95%B0%E5%88%86%E7%A6%BB-separate-query-from-modifier">将查询函数和修改函数分离</a>手法隔离副作用。</p></div> <p>5、测试；<br>
6、应用<a href="#%E5%86%85%E8%81%94%E5%8F%98%E9%87%8F-inline-variable">内联变量</a>手法移除临时变量。</p> <h2 id="将查询函数和修改函数分离-separate-query-from-modifier"><a href="#将查询函数和修改函数分离-separate-query-from-modifier" class="header-anchor">#</a> 将查询函数和修改函数分离(Separate Query from Modifier)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getTotalOutstandingAndSendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> customer<span class="token punctuation">.</span>invoices<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> each</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> each<span class="token punctuation">.</span>amount <span class="token operator">+</span> total<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">totalOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> customer<span class="token punctuation">.</span>invoices<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> each</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> each<span class="token punctuation">.</span>amount <span class="token operator">+</span> total<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">sendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    emailGateway<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">formatBill</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-4"><a href="#动机-4" class="header-anchor">#</a> 动机</h3> <p>“既有返回值又有副作用”的函数，试着将查询动作从修改动作中分离出来。</p> <h3 id="做法-4"><a href="#做法-4" class="header-anchor">#</a> 做法</h3> <p>1、复制整个函数，将其作为一个查询来命名；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果想不出好名字，可以看看函数返回的是什么。查询的结果会被填入一个变量，这个变量的名字应该能对函数如何命名有所启发。</p></div> <p>2、新建的查询函数中去掉所有造成副作用的语句；<br>
3、执行静态见检查；<br>
4、查找所有调用原函数的地方。如果调用处用到了该函数的返回值，就将其改为调用新建的查询函数，并在下面马上再调用一次原函数。每次修改之后都要测试；<br>
5、从原函数中去掉返回值；<br>
6、测试。<br>
完成重构之后，查询函数与原函数之间常会有重复代码，可以做必要的清理。</p> <h2 id="内联变量-inline-variable"><a href="#内联变量-inline-variable" class="header-anchor">#</a> 内联变量(Inline Variable)</h2> <p>曾用名：内联临时变量<br>
反向重构：提炼变量</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> basePrice <span class="token operator">=</span> anOrder<span class="token punctuation">.</span>basePrice<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">return</span> anOrder<span class="token punctuation">.</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-5"><a href="#动机-5" class="header-anchor">#</a> 动机</h3> <p>1、变量名字并不比表达式本身更具有表现力；<br>
2、变量可能会妨碍重构附近的代码。</p> <h3 id="做法-5"><a href="#做法-5" class="header-anchor">#</a> 做法</h3> <p>1、检查确认变量赋值语句的右侧表达式没有副作用；<br>
2、如果变量没有被声明为不可修改，先将其变为不可修改，并执行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这是为了确保该变量只被赋值一次。</p></div> <p>3、找到第一处使用该变量的地方，将其替换为直接使用赋值语句的右侧表达式；<br>
4、测试；<br>
5、重复前面两部，逐一替换其他使用该变量的地方；<br>
6、删除该变量的声明点和赋值语句；<br>
7、测试。</p> <h2 id="改变函数声明-change-function-declaration"><a href="#改变函数声明-change-function-declaration" class="header-anchor">#</a> 改变函数声明(Change Function Declaration)</h2> <p>别名：函数改名、修改签名<br>
曾用名：函数改名、添加参数、移除参数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">circum</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">circumference</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-6"><a href="#动机-6" class="header-anchor">#</a> 动机</h3> <p>1、有更好的函数名字；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一个好名字能让我们一眼看出函数的用途，而不必查看其实现代码。</p></div> <p>2、改变参数列表，使函数的应用范围增加。</p> <h3 id="做法-6"><a href="#做法-6" class="header-anchor">#</a> 做法</h3> <p>简单的做法：<br>
1、如果想要移除一个参数，需要先确定函数体内没有使用该参数；<br>
2、修改函数声明，使其成为你期望的状态；<br>
3、找出所有使用旧的函数声明的地方，将它们改为使用新得函数声明；<br>
4、测试。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>最好能把大的修改拆成小的步骤，所以如果你既想修改函数名，又想添加参数，最好分成两步来做。（并且，不论何时，如果遇到了麻烦，请撤销修改，并改用迁移式做法，）</p></div> <p>迁移式做法：<br>
1、如果有必要的话，先对函数内部加以重构，使后面的提炼步骤易于开展；<br>
2、使用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>将函数提炼成一个新函数。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果你打算沿用旧函数的名字，可以先给新函数起一个易于搜索 的临时名字。</p></div> <p>3、如果提炼出的函数需要新增参数，用前面的简单做法添加即可；<br>
4、测试；<br>
5、对旧函数使用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>；<br>
6、如果新函数用了临时的名字，再次使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>将其改回原来的名字；<br>
7、测试。</p> <h2 id="内联函数-inline-function"><a href="#内联函数-inline-function" class="header-anchor">#</a> 内联函数(Inline Function)</h2> <p>曾用名：内联函数<br>
反向重构：提炼函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getRating</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">moreThanFiveLateDeliveries</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">moreThanFiveLateDeliveries</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> driver<span class="token punctuation">.</span>numberOfLateDeliveries <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getRating</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>driver<span class="token punctuation">.</span>numberOfLateDeliveries <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-7"><a href="#动机-7" class="header-anchor">#</a> 动机</h3> <p>1、函数内部代码和函数名称同样清晰易读；<br>
2、一群组织不甚合理的函数；<br>
3、代码有太多间接层，使得系统中所有函数都似乎只是对另一个函数的简单委托，造成在这些委托动作之间晕头转向。</p> <h3 id="做法-7"><a href="#做法-7" class="header-anchor">#</a> 做法</h3> <p>1、检查函数，确定它不具多态性；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果该函数属于一个类，并且有子类继承了这个函数，那么就无法内联。</p></div> <p>2、找出这个函数的所有调用点；<br>
3、将这个函数的所有调用点都替换为函数本体；<br>
4、每次替换之后，执行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>不必一次完成整个内联操作。如果某些调用点毕竟难以内联，可以等到时机成熟后再来处理。</p></div> <p>5、删除该函数的定义。</p> <h2 id="搬移语句到调用者-move-statements-to-callers"><a href="#搬移语句到调用者-move-statements-to-callers" class="header-anchor">#</a> 搬移语句到调用者(Move Statements to Callers)</h2> <p>反向重构：搬移语句到函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 

</code></pre></div><h3 id="动机-8"><a href="#动机-8" class="header-anchor">#</a> 动机</h3> <p>把表现不同的行为从函数里挪出，并搬移到其调用处；</p> <h3 id="做法-8"><a href="#做法-8" class="header-anchor">#</a> 做法</h3> <p>1、最简单的情况下，原函数非常简单，其调用者也只有寥寥一两个，此时只需把要搬移的代码从函数里剪切出来并粘贴回调用端即可，必要的时候做些调整。运行测试，如果测试通过，那些大功告成，本手法可以到此为止；<br>
2、若调用点不止一两点，则需要先用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>将你不想搬移的代码提炼成一个新函数，函数名可以临时起一个，只要后续容易搜索即可。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果原函数是一个超类方法，并且有子类进行了覆盖，那么还需要对所有子类的覆盖方法进行同样的提炼操作，保证继承体系上每个类都有一份与超类相同的提炼函数。接着将子类的提炼函数删除，让它们引用超类提炼出来的函数。</p></div> <p>3、对原函数应用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a><br>
4、对提炼出来的函数应用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，令其与原函数使用同一个名字。如果你能想到更好的名字，那就用更好的那个。</p> <h2 id="变量改名-rename-variable"><a href="#变量改名-rename-variable" class="header-anchor">#</a> 变量改名(Rename Variable)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> a <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> area <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-9"><a href="#动机-9" class="header-anchor">#</a> 动机</h3> <p>1、好的命名时整洁编程的核心；<br>
2、变量可以很好地解释一段程序在干什么。</p> <h3 id="做法-9"><a href="#做法-9" class="header-anchor">#</a> 做法</h3> <p>1、如果变量被广泛使用，考虑<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>将其封装起来；<br>
2、找出所有使用该变量的代码，逐一修改；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果在另一个代码库中使用了该变量，这就是一个“已发布变量”，此时不能进行这个重构。<br>
如果变量值从不修改，可以将其复制到一个新名字之下，然后逐一修改使用代码，每次修改后执行测试。</p></div> <p>3、测试。</p> <h2 id="封装变量-encapsulate-variable"><a href="#封装变量-encapsulate-variable" class="header-anchor">#</a> 封装变量(Encapsulate Variable)</h2> <p>曾用名：自封装字段、封装字段</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> defaultOwner <span class="token operator">=</span> <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">&quot;Martin&quot;</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">&quot;Fowler&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> defaultOwnerData <span class="token operator">=</span> <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">&quot;Martin&quot;</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">&quot;Fowler&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defaultOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> defaultOwnerData<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setDefaultOwner</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> defaultOwnerData <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-10"><a href="#动机-10" class="header-anchor">#</a> 动机</h3> <p>封装能提供一个清晰的观测点</p> <h3 id="做法-10"><a href="#做法-10" class="header-anchor">#</a> 做法</h3> <p>1、创建封装函数，在其中访问和更新变量值；<br>
2、执行静态检查；<br>
3、逐一修改使用该变量的代码，将其改为调用合适的封装函数。每次替换之后，执行测试；<br>
4、限制变量的可见性。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>有时没办法阻止直接访问变量。若果真如此，可以试试将变量改名，再执行测试，找出仍在直接使用该变量的代码。</p></div> <p>5、测试；<br>
6、如果变量的值时一个记录，考虑使用封装记录。</p> <h2 id="封装记录-encapsulate-record"><a href="#封装记录-encapsulate-record" class="header-anchor">#</a> 封装记录(Encapsulate Record)</h2> <p>曾用名：以数据类取代记录</p> <div class="language-js extra-class"><pre class="language-js"><code>  organizetion <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;Acme Gooseberries&quot;</span><span class="token punctuation">,</span> country<span class="token operator">:</span> <span class="token string">&quot;GE&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Organizetion</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_country <span class="token operator">=</span> data<span class="token punctuation">.</span>country<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">country</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_country<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">country</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_country <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-11"><a href="#动机-11" class="header-anchor">#</a> 动机</h3> <p>1、将数据作为有意义的单元传递，而不仅是一堆数据的拼凑；<br>
2、其结构需要变更或者需要修改记录内的值，封装能够帮我更好地应用变化。</p> <h3 id="做法-11"><a href="#做法-11" class="header-anchor">#</a> 做法</h3> <p>1、对持有记录的变量使用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>，将其封装到一个函数中；<br>
2、创建一个类，将记录包装起来，并将记录变量的值替换为该类的一个实例。然后在类上定义一个访问函数，用于返回原始的记录。修改封装变量的函数，令其使用这个访问函数。<br>
3、测试；<br>
4、新建一个函数，让它返回该类的对象，而非那条原始的记录；<br>
5、对于该记录的每处使用点，将原先返回记录的函数调用替换为那个返回实列对象的函数调用。使用对象上的访问函数来获取数据的字段，如果该字段的访问函数还不存在，那就创建一个。每次更改之后运行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果该记录比较复杂，例如是个嵌套结构，那么先重点关注客户端对数据的更新操作，对于读取操作可以考虑返回一个数据副本或只读的数据代理。</p></div> <p>6、移除类对原始记录的访问函数，那个容易搜索的返回原始数据的函数也要一并删除；<br>
7、测试；<br>
8、如果记录中的字段本身也是复杂结构，考虑对其再次应用<a href="#%E5%B0%81%E8%A3%85%E8%AE%B0%E5%BD%95-encapsulate-record">封装记录</a>或<a href="#%E5%B0%81%E8%A3%85%E9%9B%86%E5%90%88-encapsulate-collection">封装集合</a>手法。</p> <h2 id="封装集合-encapsulate-collection"><a href="#封装集合-encapsulate-collection" class="header-anchor">#</a> 封装集合(Encapsulate Collection)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses <span class="token operator">=</span> aList<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token function">addCourse</span><span class="token punctuation">(</span><span class="token parameter">aCourse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token function">removeCourse</span><span class="token punctuation">(</span><span class="token parameter">aCourse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-12"><a href="#动机-12" class="header-anchor">#</a> 动机</h3> <p>1、更改数据结构时更加方便；<br>
2、为类提供一些修改集合的方法————通常是“添加”和“移除”。</p> <h3 id="做法-12"><a href="#做法-12" class="header-anchor">#</a> 做法</h3> <p>1、如果集合的引用尚未背封装起来，先用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>封装它；<br>
2、在类上添加用于“添加集合元素”和“移除集合元素”的函数；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果存在对该集合的设值函数，尽可能先用<a href="#%E7%A7%BB%E9%99%A4%E8%AE%BE%E5%80%BC%E5%87%BD%E6%95%B0-remove-setting-mehotd">移除设值函数</a>移除它。如果不能移除该设值函数，至少让它返回集合的一份副本。</p></div> <p>3、执行静态检查；<br>
4、查找集合的引用点。如果有调用者直接修改集合，令该处调用使用新得添加/移除元素的函数。每次修改后执行测试；<br>
5、修改集合的取值函数，使其返回一份只读的数据，可以使用只读代理或数据副本；<br>
6、测试。</p> <h2 id="移除设值函数-remove-setting-mehotd"><a href="#移除设值函数-remove-setting-mehotd" class="header-anchor">#</a> 移除设值函数(Remove Setting Mehotd)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token parameter">aString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-13"><a href="#动机-13" class="header-anchor">#</a> 动机</h3> <p>1、不希望在对象创建之后此字段还有机会被改变；<br>
2、只能在构造函数中赋值；</p> <h3 id="做法-13"><a href="#做法-13" class="header-anchor">#</a> 做法</h3> <p>1、如果构造函数尚无法得到想要设入字段的值，就使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>将这个值以参数的形式传入构造函数。在构造函数中调用设值函数，对字段设值。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果想移除多个设值函数，可以一次性把它们的值都传入构造函数，这能简化后续步骤。</p></div> <p>2、移除所有在构造函数之外对设值函数的调用，改为使用新的构造函数。每次修改之后都要测试。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果不能把“调用设值函数”替换为“创建一个新对象”(例如你需要更新一个多处共享引用的对象)，请放弃本重构。</p></div> <p>3、使用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>消除设值函数。如果可能的话，把字段声明为不可变。<br>
4、测试。</p> <h2 id="以对象取代基本类型-replace-primitive-with-object"><a href="#以对象取代基本类型-replace-primitive-with-object" class="header-anchor">#</a> 以对象取代基本类型(Replace Primitive with Object)</h2> <p>曾用名：以对象取代数据值、以类取代类型码</p> <div class="language-js extra-class"><pre class="language-js"><code>  orders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;high&quot;</span> <span class="token operator">===</span> o<span class="token punctuation">.</span>priority <span class="token operator">||</span> <span class="token string">&quot;rush&quot;</span> <span class="token operator">===</span> o<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  orders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>priority<span class="token punctuation">.</span><span class="token function">higherThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Priority</span><span class="token punctuation">(</span><span class="token string">&quot;normal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="动机-14"><a href="#动机-14" class="header-anchor">#</a> 动机</h3> <p>1、对某个数据的操作不仅仅局限于打印时，可以为它创建一个新类；<br>
2、只要类有了，日后添加的业务逻辑就有地方可以去了。</p> <h3 id="做法-14"><a href="#做法-14" class="header-anchor">#</a> 做法</h3> <p>1、如果变量尚未被封装起来，先使用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>封装它；<br>
2、为这个数据值创建一个简单的类。类的构造函数应该保存这个数据值，并未它提供一个取值函数；<br>
3、执行静态检查；<br>
4、修改第一步得到的设置函数，令其创建一个新类的对象并将其存入字段，如果有必要的话，同时修改字段的类型声明；<br>
5、修改取值函数，令其调用新类的取值函数，并返回结果；<br>
6、测试；<br>
7、考虑对第一步得到的访问函数使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，以便更好反映其用途；<br>
8、考虑应用<a href="">将引用对象改为值对象</a>或<a href="">将值对象改为引用对象</a>，明确指出新对象的角色是值对象还是引用对象</p> <h2 id="将引用对象改为值对象-change-reference-to-value"><a href="#将引用对象改为值对象-change-reference-to-value" class="header-anchor">#</a> 将引用对象改为值对象(Change Reference to Value)</h2> <p>反向重构：将值对象改为引用对象</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token function">applyDiscount</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>amount <span class="token operator">-=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token function">applyDiscount</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_price <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>amount <span class="token operator">-</span> arg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>currency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-15"><a href="#动机-15" class="header-anchor">#</a> 动机</h3> <p>如果想在几个对象之间共享一个对象，以便几个对象都能看到对共享对象的修改，那么这个共享的对象就应该是引用。</p> <h3 id="做法-15"><a href="#做法-15" class="header-anchor">#</a> 做法</h3> <p>1、检查重构目标是否为不可变对象，或者是否为可修改为不可变对象；<br>
2、用<a href="#%E7%A7%BB%E9%99%A4%E8%AE%BE%E5%80%BC%E5%87%BD%E6%95%B0-remove-setting-mehotd">移除设值函数</a>逐一去掉所有设值函数；<br>
3、提供一个基于值得相等性判断函数，在其中使用值对象得字段。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>大多数编程语言都提供了可覆写的相等性判断函数。通常你还必须同时覆写生成散列码的函数。</p></div> <h2 id="将值对象改为引用对象-change-value-to-reference"><a href="#将值对象改为引用对象-change-value-to-reference" class="header-anchor">#</a> 将值对象改为引用对象(Change Value to Reference)</h2> <p>反向重构：将引用对象改为值对象</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> customer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Costomer</span><span class="token punctuation">(</span>customerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> customer <span class="token operator">=</span> customerRepository<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>customerData<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-16"><a href="#动机-16" class="header-anchor">#</a> 动机</h3> <hr> <h3 id="做法-16"><a href="#做法-16" class="header-anchor">#</a> 做法</h3> <p>1、为相关对象创建一个仓库（如果没有这样一个仓库的话）；<br>
2、确保构造函数有办法找到对象的正确实例；<br>
3、修改宿主对象的构造函数，令其从仓库中获取关联对象。每次修改后执行测试。</p> <h2 id="提炼类-extract-class"><a href="#提炼类-extract-class" class="header-anchor">#</a> 提炼类(Extract Class)</h2> <p>反向重构：内联类</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">officeAreaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_officeAreaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">officeNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_officeNumber<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">officeAreaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_telphoneNumber<span class="token punctuation">.</span>areaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">officeNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_telphoneNumber<span class="token punctuation">.</span>number<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">class</span> <span class="token class-name">TelephoneNumber</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">areaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_areaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_number<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-17"><a href="#动机-17" class="header-anchor">#</a> 动机</h3> <p>一个类应该是一个清晰的抽象，只处理一些明确的责任；</p> <h3 id="做法-17"><a href="#做法-17" class="header-anchor">#</a> 做法</h3> <p>1、确定如何分解类所负的责任；<br>
2、创建一个新的类，用以表现从旧类中分离出来的责任；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果旧类剩下的责任与旧类的名称不符，为旧类改名。</p></div> <p>3、构造旧类时创建一个新类的实例，建立“从旧类访问新类”的连接关系；<br>
4、对于你想搬移的每一个字段，运用<a href="#%E6%90%AC%E7%A7%BB%E5%AD%97%E6%AE%B5-move-field">搬移字段</a>搬移之。每次更改后运行测试；<br>
5、使用<a href="">搬移函数</a>将必要函数搬移到新类。先搬移较底层函数（也就是“被其他函数调用”多于“调用其他函数”者）。每次更改后运行测试；<br>
6、检查两个类的接口，去掉不再需要的函数，必要时为函数重新取一个适合新环境的名字；<br>
7、决定是否公开新的类。如果确定需要，考虑对新类应用将<a href="#%E5%B0%86%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%94%B9%E4%B8%BA%E5%80%BC%E5%AF%B9%E8%B1%A1-change-reference-to-value">将引用对象改为值对象</a>使其成为一个值对象。</p> <h2 id="搬移字段-move-field"><a href="#搬移字段-move-field" class="header-anchor">#</a> 搬移字段(Move Field)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plan<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">discountRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_discountRate<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plan<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">discountRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plan<span class="token punctuation">.</span>_discountRate<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-18"><a href="#动机-18" class="header-anchor">#</a> 动机</h3> <h3 id="做法-18"><a href="#做法-18" class="header-anchor">#</a> 做法</h3> <p>1、确保源字段已经得到了良好封装；<br>
2、测试；<br>
3、在目标对象上创建一个字段（及对应的访问函数）；<br>
4、执行静态检查；<br>
5、确保源对象里能够正常引用目标对象；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>也许你已经有现成的字段或方法得到目标对象。如果没有，看看是否能简单地创建一个方法完成此事。如果还是不行，你可能就得在源对象里创建一个字段，用于存储目标对象了。这次修改可能保留很久，但你也可以只做临时修改，等到系统其他部分的重构完成就回来移除它。</p></div> <p>6、调整源对象的访问函数，令其使用目标对象的字段；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果源类的所有实例对象都共享对目标对象的访问权，那么可以考虑先更新源类的设值函数，让它修改源字段时，对目标对象上的字段做同样的修改。然后，再通过<a href="#%E5%BC%95%E5%85%A5%E6%96%AD%E8%A8%80-move-function">引入断言</a>，当检测到源字段和目标字段不一致时抛出错误。一旦你确定改动没有引入任何可观察的行为变化，就可以放心地让访问函数直接使用目标对象的字段了。</p></div> <p>7、测试；<br>
8、移除源对象上的字段；<br>
9、测试。</p> <h2 id="搬移函数-move-function"><a href="#搬移函数-move-function" class="header-anchor">#</a> 搬移函数(Move Function)</h2> <p>曾用名：搬移函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">overdraftChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">AccountType</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">overdraftChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-19"><a href="#动机-19" class="header-anchor">#</a> 动机</h3> <p>1、保证相互关联的软件要素要集中到一块，并确保块与块之间的联系易于查找、直观易懂；<br>
2、任何函数都需要具备上下文环境才能存活。</p> <h3 id="做法-19"><a href="#做法-19" class="header-anchor">#</a> 做法</h3> <p>1、检查函数在当前上下文里引用的所有程序元素（包括变量和函数），考虑是否需要将它们一并搬移；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果发现有些被调用的函数也需要搬移，我通常会先搬移它们。这样可以保证移动一组函数时，总是从依赖最少的那个函数入手。<br>
如果该函数拥有一些子函数，并且它是这些子函数的唯一调用者，那么你可以先将子函数内联进来，一并搬移到新家后再重新提炼出子函数。</p></div> <p>2、检查待搬移函数是否具备多态性；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在面向对象的语言里，还需要考虑该函数是否覆写了超类的函数，或者为子类所覆写。</p></div> <p>3、将函数复制一份到目标上下文中。调整函数，使它能适应新家。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果函数里用到了源上下文中的元素，我就得将这些元素一并传递过去，要么通过函数参数，要么使将当前上下文的引用传递到新得上下文那边去。<br>
搬移函数通常意味着，我还得给它起个新名字，使它更符合新的上下文。</p></div> <p>4、执行静态检查；<br>
5、设法从源上下文中正确引用目标函数；<br>
6、修改源函数，使之成为一个纯委托函数；<br>
7、测试；<br>
8、考虑对源函数使用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>也可以不做内联，让源函数一直做委托调用。但如果调用方直接调用目标函数也不费不太多周折，那么最好还是把中间人移除掉。</p></div> <h2 id="引入断言-intraduce-assertion"><a href="#引入断言-intraduce-assertion" class="header-anchor">#</a> 引入断言(Intraduce Assertion)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountRate<span class="token punctuation">)</span> 
    base <span class="token operator">=</span> base <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountRate <span class="token operator">*</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountRate <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountRate<span class="token punctuation">)</span> 
    base <span class="token operator">=</span> base <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountRate <span class="token operator">*</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-20"><a href="#动机-20" class="header-anchor">#</a> 动机</h3> <p>1、只有当某个条件为真时，该段代码才能正常运行；<br>
2、断言是一个条件表达式，应该总是为真。如果它失败，表示程序员犯了错误；<br>
3、断言是一种很有价值的交流形式。</p> <h3 id="做法-20"><a href="#做法-20" class="header-anchor">#</a> 做法</h3> <p>如果你发现代码假设某个条件始终为真，就加入一个断言明确说明这种情况。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>因为断言应该不会对系统运行造成任何影响，所以“加入断言”永远都应该是行为保持的。</p></div> <h2 id="移动语句-slide-statements"><a href="#移动语句-slide-statements" class="header-anchor">#</a> 移动语句(Slide Statements)</h2> <p>曾用名：合并重复的代码片段</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> pricingPlan <span class="token operator">=</span> <span class="token function">retrievePricingPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token function">retreiveOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> charge<span class="token punctuation">;</span>
  <span class="token keyword">const</span> chargePerUnit <span class="token operator">=</span> pricingPlan<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> pricingPlan <span class="token operator">=</span> <span class="token function">retrievePricingPlan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> chargePerUnit <span class="token operator">=</span> pricingPlan<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token function">retreiveOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> charge<span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-21"><a href="#动机-21" class="header-anchor">#</a> 动机</h3> <p>让存在关联的东西一起出现，可以使代码更容易理解。</p> <h3 id="做法-21"><a href="#做法-21" class="header-anchor">#</a> 做法</h3> <p>1、确定待移动的代码片段应该被搬往何处。仔细检查移动片段与目的地之间的语句，看看搬移后是否会影响这些代码正常工作。如果会，则放弃这项重构；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>往前以动代码片段时，如果片段中声明了变量，则不允许以动到任何变量的声明语句之前。往后移动代码片段时，如果有语句引用了待移动片段中的变量，则不允许移动到该语句之后。往后移动代码片段时，如果有语句修改了待移动片段中引用的变量，则不允许移动到该语句之后。往后移动代码片段时，如果片段中修改了某些元素，则不允许移动到任何引用了这些元素的语句之后。</p></div> <p>2、剪切源代码片段，粘贴到上一步选定的位置上；<br>
3、测试。</p> <h2 id="拆分变量-split-variable"><a href="#拆分变量-split-variable" class="header-anchor">#</a> 拆分变量(Split Variable)</h2> <p>曾用名：移除对参数的赋值、分解临时变量</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>height <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  temp <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> perimeter <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>height <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cosnole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>permeter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> area <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-22"><a href="#动机-22" class="header-anchor">#</a> 动机</h3> <p>1、如果变量被赋值超过一次，就意味着它们在函数中承担了一个以上的责任。如果变量承担多个责任，他就应该被替换（分解）为多个变量，每个变量只承担一个责任；<br>
2、同一个变量承担两件不同的事情，会令代码阅读者糊涂。</p> <h3 id="做法-22"><a href="#做法-22" class="header-anchor">#</a> 做法</h3> <p>1、在待分解变量的声明以其第一次被赋值处，修改其名称；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果稍后的赋值语句是“i=i+某表达式形式”，意味着这是一个结果收集变量，就不要分解它。结果收集变量常用于累加、字符串拼接、写入流或者向集合添加元素。</p></div> <p>2、如果可能的话，将新的变量声明为不可修改；<br>
3、以该变量的第二次赋值动作为界，修改此前对该变量的所有引用，让它们引用新变量；<br>
4、测试；<br>
5、重复以上过程。每次都在声明处对变量改名，并修改下次赋值之前的引用，直至到达最后一处赋值。</p> <h2 id="内联类-inline-class"><a href="#内联类-inline-class" class="header-anchor">#</a> 内联类(Inline Class)</h2> <p>反向重构：提炼类</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">officeAreaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_telphoneNumber<span class="token punctuation">.</span>areaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">officeNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_telphoneNumber<span class="token punctuation">.</span>number<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">class</span> <span class="token class-name">TelephoneNumber</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">areaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_areaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_number<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">officeAreaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_officeAreaCode<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">officeNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_officeNumber<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-23"><a href="#动机-23" class="header-anchor">#</a> 动机</h3> <p>一个类不再承担足够责任，不再有单独存在的理由。</p> <h3 id="做法-23"><a href="#做法-23" class="header-anchor">#</a> 做法</h3> <p>1、对于待内联类（源类）中的所有public函数，在目标类上创建上创建一个对应的函数，新创建的所有函数应该直接委托至源类；<br>
2、修改源类public方法的所有引用点，令它们调用目标类对应的委托方法。每次更改后运行测试；<br>
3、将源类中的函数与数据全部搬移到目标类，每次修改之后进行测试，直到源类变成空壳为止；<br>
4、删除源类，为它举行一个简单的“丧礼”。</p> <h2 id="隐藏委托关系-hide-delegate"><a href="#隐藏委托关系-hide-delegate" class="header-anchor">#</a> 隐藏委托关系(Hide Delegate)</h2> <p>反向重构：移除中间人</p> <div class="language-js extra-class"><pre class="language-js"><code>  manager <span class="token operator">=</span> aPerson<span class="token punctuation">.</span>department<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  manager <span class="token operator">=</span> aPerson<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>

  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>department<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-24"><a href="#动机-24" class="header-anchor">#</a> 动机</h3> <h3 id="做法-24"><a href="#做法-24" class="header-anchor">#</a> 做法</h3> <p>1、对于每个委托关系中的函数，在服务对象端建立一个简单的委托函数；<br>
2、调整客户端，令它调用服务对象提供的函数。每次调整后运行测试；<br>
3、如果将来不再有任何客户端需要取用Delegate（受托类），便可移除服务对象中的相关访问函数；<br>
4、测试。</p> <h2 id="移除中间人-remove-middle-man"><a href="#移除中间人-remove-middle-man" class="header-anchor">#</a> 移除中间人(Remove Middle Man)</h2> <p>反向重构：隐藏委托关系</p> <div class="language-js extra-class"><pre class="language-js"><code>  manager <span class="token operator">=</span> aPerson<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>
  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>department<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  manager <span class="token operator">=</span> aPerson<span class="token punctuation">.</span>department<span class="token punctuation">.</span>manager<span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-25"><a href="#动机-25" class="header-anchor">#</a> 动机</h3> <h3 id="做法-25"><a href="#做法-25" class="header-anchor">#</a> 做法</h3> <p>1、为受托对象创建一个取值函数；<br>
2、对于每个委托，让其客户端转为连续的访问函数调用，每次替换后运行测试。</p> <h2 id="替换算法-substitute-algorithm"><a href="#替换算法-substitute-algorithm" class="header-anchor">#</a> 替换算法(Substitute Algorithm)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">foundPerson</span><span class="token punctuation">(</span><span class="token parameter">people</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> people<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>people<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">===</span><span class="token string">'Don'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'Don'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>people<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">===</span><span class="token string">'John'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'John'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>people<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">===</span><span class="token string">'Kent'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'Kent'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">foundPerson</span><span class="token punctuation">(</span><span class="token parameter">people</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> candidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Don'</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Kent'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> people<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> candidates<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-26"><a href="#动机-26" class="header-anchor">#</a> 动机</h3> <h3 id="做法-26"><a href="#做法-26" class="header-anchor">#</a> 做法</h3> <p>1、整理一个代替换的算法，保证它已经被抽取到一个独立的函数中；<br>
2、先只为这个函数准备测试，以便固定它的行为；<br>
3、准备好另一个（替换用）算法；<br>
4、执行静态检查；<br>
5、运行测试，比对新旧算法的运行结果。如果测试通过，那就大功告成；否则，在后续测试和调试过程中，以旧算法为比较参照标准。</p> <h2 id="搬移语句到函数-move-statements-into-function"><a href="#搬移语句到函数-move-statements-into-function" class="header-anchor">#</a> 搬移语句到函数(Move Statements into Function)</h2> <p>反向重构：搬移语句到调用者</p> <div class="language-js extra-class"><pre class="language-js"><code>  result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">photoData</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">photoData</span><span class="token punctuation">(</span><span class="token parameter">aPhoto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>data<span class="token punctuation">.</span>toDateString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  result<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">photoData</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">photoData</span><span class="token punctuation">(</span><span class="token parameter">aPhoto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>data<span class="token punctuation">.</span>toDateString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-27"><a href="#动机-27" class="header-anchor">#</a> 动机</h3> <p>1、消除重复；<br>
2、某些语句与一个函数放在一起更像一个整体。</p> <h3 id="做法-27"><a href="#做法-27" class="header-anchor">#</a> 做法</h3> <p>1、如果重复的代码段离调用目标函数的地方还有些距离，则先用<a href="#%E7%A7%BB%E5%8A%A8%E8%AF%AD%E5%8F%A5-slide-statements">移动语句</a>将这些语句挪到紧邻目标函数的位置；<br>
2、如果目标函数仅被唯一一个源函数调用，那么只需将源函数中的重复代码段剪切并粘贴到目标函数中即可，然后运行测试。本做法的后续步骤至此可以忽略；<br>
3、如果函数不止一个调用点，那么先选择一个调用点应用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>，将待搬移的语句与目标函数一起提炼成一个新函数。给新函数取个临时的名字，只要易于搜索即可；<br>
4、调整函数的其他调用点，令它们调用新提炼的函数。每次调整之后运行测试；<br>
5、完成所有引用点的替换后，应用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>将目标函数内联到新函数里，并移除原目标函数；<br>
6、对新函数应用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，将其改名为原目标函数的名字。</p> <h2 id="搬移语句到调用者-move-statements-to-callers-2"><a href="#搬移语句到调用者-move-statements-to-callers-2" class="header-anchor">#</a> 搬移语句到调用者(Move Statements to Callers)</h2> <p>反向重构：搬移语句到函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aPhoto<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre></div><h3 id="动机-28"><a href="#动机-28" class="header-anchor">#</a> 动机</h3> <p>函数发生了偏移。</p> <h3 id="做法-28"><a href="#做法-28" class="header-anchor">#</a> 做法</h3> <p>1、最简单的情况下，原函数非常简单，其调用者也只有寥寥一两个，此时只需把要搬移的代码从函数里剪切出来并粘贴回调用端去即可，必要的时候做些调整。运行测试。如果测试通过，那就大功告成，本手法可以到此为止。<br>
2、若调用点不止一两个，则需要先用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>将你不想搬移的代码提炼成一个新函数，函数名可以临时起一个，只要后续容易搜索即可。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果原函数是一个超类方法，并且子类进行了覆写，那么还需要对所有子类的覆写方法进行同样的提炼操作，保证继承体系上每个类都有一份与超类相同的提炼函数。接着将子类的提炼函数删除，让它引用超类提炼出来的函数。</p></div> <p>3、对原函数应用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>；<br>
4、对提炼出来的函数应用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，令其与原函数使用同一个名字。如果你能想到更好的名字，那就用更好的那个。</p> <h2 id="以管道取代循环-replace-loop-with-pipeline"><a href="#以管道取代循环-replace-loop-with-pipeline" class="header-anchor">#</a> 以管道取代循环(Replace Loop with Pipeline)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> i <span class="token keyword">of</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>job <span class="token operator">===</span> <span class="token string">'programmer'</span><span class="token punctuation">)</span>
      names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> names <span class="token operator">=</span> input
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>job <span class="token operator">===</span> <span class="token string">'programmer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-29"><a href="#动机-29" class="header-anchor">#</a> 动机</h3> <h3 id="做法-29"><a href="#做法-29" class="header-anchor">#</a> 做法</h3> <p>1、创建一个新变量，用以存放参与循环过程的集合；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>也可以简单地复制一个现有的变量赋值给新变量。</p></div> <p>2、从循环顶部开始，将循环里得到每一块行为依次搬移出来，在上一步创建的集合变量上用一种管道运算替代之。每次修改后运行测试；<br>
3、搬移完循环里的全部行为后，将循环整个删除。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果循环内部通过累加变量来保存结果，那么移除循环后，将管道运算的最终结果赋值给该累加变量。</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/chore/bad-smell.html" class="prev">
        代码的怪味道
      </a></span> <span class="next"><a href="/book/chore/good-words.html">
        好句子
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6306d817.js" defer></script><script src="/assets/js/2.e437a02e.js" defer></script><script src="/assets/js/26.7e911e6f.js" defer></script>
  </body>
</html>
