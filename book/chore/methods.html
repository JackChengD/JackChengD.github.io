<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>重构手法 | Jack</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="describe myself">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d23418ae.js" as="script"><link rel="preload" href="/assets/js/2.eab5a6f5.js" as="script"><link rel="preload" href="/assets/js/26.c86453be.js" as="script"><link rel="prefetch" href="/assets/js/10.3d3f0539.js"><link rel="prefetch" href="/assets/js/11.9d1b0fa6.js"><link rel="prefetch" href="/assets/js/12.db05c5e3.js"><link rel="prefetch" href="/assets/js/13.e52b274b.js"><link rel="prefetch" href="/assets/js/14.79017e98.js"><link rel="prefetch" href="/assets/js/15.518bba56.js"><link rel="prefetch" href="/assets/js/16.c4f0feca.js"><link rel="prefetch" href="/assets/js/17.e2713cf6.js"><link rel="prefetch" href="/assets/js/18.9209155d.js"><link rel="prefetch" href="/assets/js/19.11b3dcb6.js"><link rel="prefetch" href="/assets/js/20.a04a6877.js"><link rel="prefetch" href="/assets/js/21.9c907d9e.js"><link rel="prefetch" href="/assets/js/22.dad1eec5.js"><link rel="prefetch" href="/assets/js/23.833e58e0.js"><link rel="prefetch" href="/assets/js/24.6741c1e6.js"><link rel="prefetch" href="/assets/js/25.d358278f.js"><link rel="prefetch" href="/assets/js/27.bbe1ed06.js"><link rel="prefetch" href="/assets/js/28.9a0fbf54.js"><link rel="prefetch" href="/assets/js/29.f624ea12.js"><link rel="prefetch" href="/assets/js/3.88356f14.js"><link rel="prefetch" href="/assets/js/30.3efd22ac.js"><link rel="prefetch" href="/assets/js/31.544a2b7c.js"><link rel="prefetch" href="/assets/js/32.f684b4b4.js"><link rel="prefetch" href="/assets/js/33.086fdbe0.js"><link rel="prefetch" href="/assets/js/34.729b08b2.js"><link rel="prefetch" href="/assets/js/35.5aa6e77d.js"><link rel="prefetch" href="/assets/js/36.fccc244a.js"><link rel="prefetch" href="/assets/js/4.e05c873c.js"><link rel="prefetch" href="/assets/js/5.f3e6ed41.js"><link rel="prefetch" href="/assets/js/6.498ab014.js"><link rel="prefetch" href="/assets/js/7.3822cadf.js"><link rel="prefetch" href="/assets/js/8.cc5610e5.js"><link rel="prefetch" href="/assets/js/9.f5f3c602.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jack</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/work/" class="nav-link">
  工作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/chore/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  leetcode
</a></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于作者
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/work/" class="nav-link">
  工作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/chore/" class="nav-link router-link-active">
  重构改善既有代码的设计
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  leetcode
</a></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于作者
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/book/chore" class="sidebar-heading clickable router-link-active open"><span>重构改善既有代码的设计</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/chore/what.html" class="sidebar-link">什么是重构</a></li><li><a href="/book/chore/why.html" class="sidebar-link">为什么要重构</a></li><li><a href="/book/chore/when.html" class="sidebar-link">什么时候要重构</a></li><li><a href="/book/chore/bad-smell.html" class="sidebar-link">代码的怪味道</a></li><li><a href="/book/chore/methods.html" aria-current="page" class="active sidebar-link">重构手法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/chore/methods.html#提炼函数-extract-function" class="sidebar-link">提炼函数(Extract Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#以函数调用取代内联代码-replace-inline-code-with-function-call" class="sidebar-link">以函数调用取代内联代码(Replace Inline Code with Function Call)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#查询取代临时变量-replace-temp-with-query" class="sidebar-link">查询取代临时变量(Replace Temp with Query)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将查询函数和修改函数分离-separate-query-from-modifier" class="sidebar-link">将查询函数和修改函数分离(Separate Query from Modifier)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#内联变量-inline-variable" class="sidebar-link">内联变量(Inline Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#改变函数声明-change-function-declaration" class="sidebar-link">改变函数声明(Change Function Declaration)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#内联函数-inline-function" class="sidebar-link">内联函数(Inline Function)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#搬移语句到调用者-move-statements-to-callers" class="sidebar-link">搬移语句到调用者(Move Statements to Callers)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#变量改名-rename-variable" class="sidebar-link">变量改名(Rename Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装变量-encapsulate-variable" class="sidebar-link">封装变量(Encapsulate Variable)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装记录-encapsulate-record" class="sidebar-link">封装记录(Encapsulate Record)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#封装集合-encapsulate-collection" class="sidebar-link">封装集合(Encapsulate Collection)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#移除设值函数-remove-setting-mehotd" class="sidebar-link">移除设值函数(Remove Setting Mehotd)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#以对象取代基本类型-replace-primitive-with-object" class="sidebar-link">以对象取代基本类型(Replace Primitive with Object)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将引用对象改为值对象-change-reference-to-value" class="sidebar-link">将引用对象改为值对象(Change Reference to Value)</a></li><li class="sidebar-sub-header"><a href="/book/chore/methods.html#将值对象改为引用对象-change-value-to-reference" class="sidebar-link">将值对象改为引用对象(Change Value to Reference)</a></li></ul></li><li><a href="/book/chore/good-words.html" class="sidebar-link">好句子</a></li><li><a href="/book/chore/from.html" class="sidebar-link">源自</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="重构手法"><a href="#重构手法" class="header-anchor">#</a> 重构手法</h1> <h2 id="提炼函数-extract-function"><a href="#提炼函数-extract-function" class="header-anchor">#</a> 提炼函数(Extract Function)</h2> <p>曾用名：提炼函数<br>
反向重构：内联函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">printOwing</span><span class="token punctuation">(</span><span class="token parameter">invoice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printBanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> outstanding <span class="token operator">=</span> <span class="token function">calculateOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// print details</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>invoice<span class="token punctuation">.</span>customer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">amount：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outstanding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">printOwing</span><span class="token punctuation">(</span><span class="token parameter">invoice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printBanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> outstanding <span class="token operator">=</span> <span class="token function">calculateOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printDetails</span><span class="token punctuation">(</span>outstanding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">printDetails</span><span class="token punctuation">(</span><span class="token parameter">outstanding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>invoice<span class="token punctuation">.</span>customer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">amount:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outstanding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机"><a href="#动机" class="header-anchor">#</a> 动机</h3> <p>1、函数过长；<br>
2、代码类似；<br>
3、明确代码用意。</p> <h3 id="做法"><a href="#做法" class="header-anchor">#</a> 做法</h3> <p>1、创建一个新函数（以它“做什么”来命名，而不是以它“怎么做”命名）；<br>
2、将待提炼的代码从源函数复制到新建的目标函数中；<br>
3、仔细检查提炼出的代码，看看其中是否引用了作用域限于源函数、在提炼出的新函数中访问不到的变量。若是，以参数的形式将它们传递给新函数；<br>
4、所有变量都处理完之后，编译；<br>
5、在源函数中，将被提炼代码段替换为对目标函数的调用；<br>
6、测试；<br>
7、查看其他代码是否有与被提炼的代码段相同或相似之处。如果有，考虑使用<a href="#%E4%BB%A5%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%8F%96%E4%BB%A3%E5%86%85%E8%81%94%E4%BB%A3%E7%A0%81-replace-inline-code-with-function-call">以函数调用取代内联代码</a>。</p> <h2 id="以函数调用取代内联代码-replace-inline-code-with-function-call"><a href="#以函数调用取代内联代码-replace-inline-code-with-function-call" class="header-anchor">#</a> 以函数调用取代内联代码(Replace Inline Code with Function Call)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> appliesToMass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> s <span class="token keyword">of</span> states<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token string">&quot;MA&quot;</span><span class="token punctuation">)</span> appliesToMass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  appliesToMass <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;MA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-2"><a href="#动机-2" class="header-anchor">#</a> 动机</h3> <p>1、善用函数可以将相关的行为打包起来；<br>
2、配合一些库函数使用，会使本手法效果更佳。</p> <h3 id="做法-2"><a href="#做法-2" class="header-anchor">#</a> 做法</h3> <p>1、将内联代码替代为对一个既有函数的调用；<br>
2、测试。</p> <h2 id="查询取代临时变量-replace-temp-with-query"><a href="#查询取代临时变量-replace-temp-with-query" class="header-anchor">#</a> 查询取代临时变量(Replace Temp with Query)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">get</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> basePrice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_quantity <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_itemPrice<span class="token punctuation">;</span>
    <span class="token keyword">var</span> discountFactor <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> discountFactor <span class="token operator">-=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> basePrice <span class="token operator">*</span> discountFactor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">get</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discountFactor<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  
  <span class="token keyword">get</span> <span class="token function">basePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_quantity <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_itemPrice<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">discountFactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> discountFactor <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> discountFactor <span class="token operator">-=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> discountFactor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-3"><a href="#动机-3" class="header-anchor">#</a> 动机</h3> <p>1、避免在多个函数中重复编写计算逻辑；<br>
2、处理某些类型的临时变量；那些只被计算一次且之后不再被修改的变量。</p> <h3 id="做法-3"><a href="#做法-3" class="header-anchor">#</a> 做法</h3> <p>1、检查变量在使用前是否已经完全计算完毕，检查计算它的那段代码是否每次都能得到一样的值；<br>
2、如果变量目前不是只读的，但是可以改造成只读变量，那就先改造它；<br>
3、测试；<br>
4、将为变量赋值的代码段提炼成函数；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果变量和函数不能使用同样的名字，那么先为函数取个临时的名字。<br>
确保待提炼函数没有副作用。若有，先应用<a href="#%E5%B0%86%E6%9F%A5%E8%AF%A2%E5%87%BD%E6%95%B0%E5%92%8C%E4%BF%AE%E6%94%B9%E5%87%BD%E6%95%B0%E5%88%86%E7%A6%BB-separate-query-from-modifier">将查询函数和修改函数分离</a>手法隔离副作用。</p></div> <p>5、测试；<br>
6、应用<a href="#%E5%86%85%E8%81%94%E5%8F%98%E9%87%8F-inline-variable">内联变量</a>手法移除临时变量。</p> <h2 id="将查询函数和修改函数分离-separate-query-from-modifier"><a href="#将查询函数和修改函数分离-separate-query-from-modifier" class="header-anchor">#</a> 将查询函数和修改函数分离(Separate Query from Modifier)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getTotalOutstandingAndSendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> customer<span class="token punctuation">.</span>invoices<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> each</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> each<span class="token punctuation">.</span>amount <span class="token operator">+</span> total<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">totalOutstanding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> customer<span class="token punctuation">.</span>invoices<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> each</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> each<span class="token punctuation">.</span>amount <span class="token operator">+</span> total<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">sendBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    emailGateway<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">formatBill</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-4"><a href="#动机-4" class="header-anchor">#</a> 动机</h3> <p>“既有返回值又有副作用”的函数，试着将查询动作从修改动作中分离出来。</p> <h3 id="做法-4"><a href="#做法-4" class="header-anchor">#</a> 做法</h3> <p>1、复制整个函数，将其作为一个查询来命名；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果想不出好名字，可以看看函数返回的是什么。查询的结果会被填入一个变量，这个变量的名字应该能对函数如何命名有所启发。</p></div> <p>2、新建的查询函数中去掉所有造成副作用的语句；<br>
3、执行静态见检查；<br>
4、查找所有调用原函数的地方。如果调用处用到了该函数的返回值，就将其改为调用新建的查询函数，并在下面马上再调用一次原函数。每次修改之后都要测试；<br>
5、从原函数中去掉返回值；<br>
6、测试。<br>
完成重构之后，查询函数与原函数之间常会有重复代码，可以做必要的清理。</p> <h2 id="内联变量-inline-variable"><a href="#内联变量-inline-variable" class="header-anchor">#</a> 内联变量(Inline Variable)</h2> <p>曾用名：内联临时变量<br>
反向重构：提炼变量</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> basePrice <span class="token operator">=</span> anOrder<span class="token punctuation">.</span>basePrice<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">return</span> anOrder<span class="token punctuation">.</span>basePrice <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-5"><a href="#动机-5" class="header-anchor">#</a> 动机</h3> <p>1、变量名字并不比表达式本身更具有表现力；<br>
2、变量可能会妨碍重构附近的代码。</p> <h3 id="做法-5"><a href="#做法-5" class="header-anchor">#</a> 做法</h3> <p>1、检查确认变量赋值语句的右侧表达式没有副作用；<br>
2、如果变量没有被声明为不可修改，先将其变为不可修改，并执行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这是为了确保该变量只被赋值一次。</p></div> <p>3、找到第一处使用该变量的地方，将其替换为直接使用赋值语句的右侧表达式；<br>
4、测试；<br>
5、重复前面两部，逐一替换其他使用该变量的地方；<br>
6、删除该变量的声明点和赋值语句；<br>
7、测试。</p> <h2 id="改变函数声明-change-function-declaration"><a href="#改变函数声明-change-function-declaration" class="header-anchor">#</a> 改变函数声明(Change Function Declaration)</h2> <p>别名：函数改名、修改签名<br>
曾用名：函数改名、添加参数、移除参数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">circum</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">circumference</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-6"><a href="#动机-6" class="header-anchor">#</a> 动机</h3> <p>1、有更好的函数名字；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一个好名字能让我们一眼看出函数的用途，而不必查看其实现代码。</p></div> <p>2、改变参数列表，使函数的应用范围增加。</p> <h3 id="做法-6"><a href="#做法-6" class="header-anchor">#</a> 做法</h3> <p>简单的做法：<br>
1、如果想要移除一个参数，需要先确定函数体内没有使用该参数；<br>
2、修改函数声明，使其成为你期望的状态；<br>
3、找出所有使用旧的函数声明的地方，将它们改为使用新得函数声明；<br>
4、测试。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>最好能把大的修改拆成小的步骤，所以如果你既想修改函数名，又想添加参数，最好分成两步来做。（并且，不论何时，如果遇到了麻烦，请撤销修改，并改用迁移式做法，）</p></div> <p>迁移式做法：<br>
1、如果有必要的话，先对函数内部加以重构，使后面的提炼步骤易于开展；<br>
2、使用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>将函数提炼成一个新函数。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果你打算沿用旧函数的名字，可以先给新函数起一个易于搜索 的临时名字。</p></div> <p>3、如果提炼出的函数需要新增参数，用前面的简单做法添加即可；<br>
4、测试；<br>
5、对旧函数使用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>；<br>
6、如果新函数用了临时的名字，再次使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>将其改回原来的名字；<br>
7、测试。</p> <h2 id="内联函数-inline-function"><a href="#内联函数-inline-function" class="header-anchor">#</a> 内联函数(Inline Function)</h2> <p>曾用名：内联函数<br>
反向重构：提炼函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getRating</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">moreThanFiveLateDeliveries</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">moreThanFiveLateDeliveries</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> driver<span class="token punctuation">.</span>numberOfLateDeliveries <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getRating</span><span class="token punctuation">(</span><span class="token parameter">driver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>driver<span class="token punctuation">.</span>numberOfLateDeliveries <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-7"><a href="#动机-7" class="header-anchor">#</a> 动机</h3> <p>1、函数内部代码和函数名称同样清晰易读；<br>
2、一群组织不甚合理的函数；<br>
3、代码有太多间接层，使得系统中所有函数都似乎只是对另一个函数的简单委托，造成在这些委托动作之间晕头转向。</p> <h3 id="做法-7"><a href="#做法-7" class="header-anchor">#</a> 做法</h3> <p>1、检查函数，确定它不具多态性；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果该函数属于一个类，并且有子类继承了这个函数，那么就无法内联。</p></div> <p>2、找出这个函数的所有调用点；<br>
3、将这个函数的所有调用点都替换为函数本体；<br>
4、每次替换之后，执行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>不必一次完成整个内联操作。如果某些调用点毕竟难以内联，可以等到时机成熟后再来处理。</p></div> <p>5、删除该函数的定义。</p> <h2 id="搬移语句到调用者-move-statements-to-callers"><a href="#搬移语句到调用者-move-statements-to-callers" class="header-anchor">#</a> 搬移语句到调用者(Move Statements to Callers)</h2> <p>反向重构：搬移语句到函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">emitPhotoData</span><span class="token punctuation">(</span>outStream<span class="token punctuation">,</span> person<span class="token punctuation">.</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;location:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>photo<span class="token punctuation">.</span>location<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">emitPhotoData</span><span class="token punctuation">(</span><span class="token parameter">outStream<span class="token punctuation">,</span> photo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;title:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>photo<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 

</code></pre></div><h3 id="动机-8"><a href="#动机-8" class="header-anchor">#</a> 动机</h3> <p>把表现不同的行为从函数里挪出，并搬移到其调用处；</p> <h3 id="做法-8"><a href="#做法-8" class="header-anchor">#</a> 做法</h3> <p>1、最简单的情况下，原函数非常简单，其调用者也只有寥寥一两个，此时只需把要搬移的代码从函数里剪切出来并粘贴回调用端即可，必要的时候做些调整。运行测试，如果测试通过，那些大功告成，本手法可以到此为止；<br>
2、若调用点不止一两点，则需要先用<a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0-extract-function">提炼函数</a>将你不想搬移的代码提炼成一个新函数，函数名可以临时起一个，只要后续容易搜索即可。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果原函数是一个超类方法，并且有子类进行了覆盖，那么还需要对所有子类的覆盖方法进行同样的提炼操作，保证继承体系上每个类都有一份与超类相同的提炼函数。接着将子类的提炼函数删除，让它们引用超类提炼出来的函数。</p></div> <p>3、对原函数应用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a><br>
4、对提炼出来的函数应用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，令其与原函数使用同一个名字。如果你能想到更好的名字，那就用更好的那个。</p> <h2 id="变量改名-rename-variable"><a href="#变量改名-rename-variable" class="header-anchor">#</a> 变量改名(Rename Variable)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> a <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> area <span class="token operator">=</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-9"><a href="#动机-9" class="header-anchor">#</a> 动机</h3> <p>1、好的命名时整洁编程的核心；<br>
2、变量可以很好地解释一段程序在干什么。</p> <h3 id="做法-9"><a href="#做法-9" class="header-anchor">#</a> 做法</h3> <p>1、如果变量被广泛使用，考虑<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>将其封装起来；<br>
2、找出所有使用该变量的代码，逐一修改；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果在另一个代码库中使用了该变量，这就是一个“已发布变量”，此时不能进行这个重构。<br>
如果变量值从不修改，可以将其复制到一个新名字之下，然后逐一修改使用代码，每次修改后执行测试。</p></div> <p>3、测试。</p> <h2 id="封装变量-encapsulate-variable"><a href="#封装变量-encapsulate-variable" class="header-anchor">#</a> 封装变量(Encapsulate Variable)</h2> <p>曾用名：自封装字段、封装字段</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> defaultOwner <span class="token operator">=</span> <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">&quot;Martin&quot;</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">&quot;Fowler&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> defaultOwnerData <span class="token operator">=</span> <span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">&quot;Martin&quot;</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">&quot;Fowler&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defaultOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> defaultOwnerData<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setDefaultOwner</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> defaultOwnerData <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-10"><a href="#动机-10" class="header-anchor">#</a> 动机</h3> <p>封装能提供一个清晰的观测点</p> <h3 id="做法-10"><a href="#做法-10" class="header-anchor">#</a> 做法</h3> <p>1、创建封装函数，在其中访问和更新变量值；<br>
2、执行静态检查；<br>
3、逐一修改使用该变量的代码，将其改为调用合适的封装函数。每次替换之后，执行测试；<br>
4、限制变量的可见性。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>有时没办法阻止直接访问变量。若果真如此，可以试试将变量改名，再执行测试，找出仍在直接使用该变量的代码。</p></div> <p>5、测试；<br>
6、如果变量的值时一个记录，考虑使用封装记录。</p> <h2 id="封装记录-encapsulate-record"><a href="#封装记录-encapsulate-record" class="header-anchor">#</a> 封装记录(Encapsulate Record)</h2> <p>曾用名：以数据类取代记录</p> <div class="language-js extra-class"><pre class="language-js"><code>  organizetion <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;Acme Gooseberries&quot;</span><span class="token punctuation">,</span> country<span class="token operator">:</span> <span class="token string">&quot;GE&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Organizetion</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_country <span class="token operator">=</span> data<span class="token punctuation">.</span>country<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">country</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_country<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">country</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_country <span class="token operator">=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-11"><a href="#动机-11" class="header-anchor">#</a> 动机</h3> <p>1、将数据作为有意义的单元传递，而不仅是一堆数据的拼凑；<br>
2、其结构需要变更或者需要修改记录内的值，封装能够帮我更好地应用变化。</p> <h3 id="做法-11"><a href="#做法-11" class="header-anchor">#</a> 做法</h3> <p>1、对持有记录的变量使用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>，将其封装到一个函数中；<br>
2、创建一个类，将记录包装起来，并将记录变量的值替换为该类的一个实例。然后在类上定义一个访问函数，用于返回原始的记录。修改封装变量的函数，令其使用这个访问函数。<br>
3、测试；<br>
4、新建一个函数，让它返回该类的对象，而非那条原始的记录；<br>
5、对于该记录的每处使用点，将原先返回记录的函数调用替换为那个返回实列对象的函数调用。使用对象上的访问函数来获取数据的字段，如果该字段的访问函数还不存在，那就创建一个。每次更改之后运行测试；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果该记录比较复杂，例如是个嵌套结构，那么先重点关注客户端对数据的更新操作，对于读取操作可以考虑返回一个数据副本或只读的数据代理。</p></div> <p>6、移除类对原始记录的访问函数，那个容易搜索的返回原始数据的函数也要一并删除；<br>
7、测试；<br>
8、如果记录中的字段本身也是复杂结构，考虑对其再次应用<a href="#%E5%B0%81%E8%A3%85%E8%AE%B0%E5%BD%95-encapsulate-record">封装记录</a>或<a href="#%E5%B0%81%E8%A3%85%E9%9B%86%E5%90%88-encapsulate-collection">封装集合</a>手法。</p> <h2 id="封装集合-encapsulate-collection"><a href="#封装集合-encapsulate-collection" class="header-anchor">#</a> 封装集合(Encapsulate Collection)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses <span class="token operator">=</span> aList<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">courses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_courses<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token function">addCourse</span><span class="token punctuation">(</span><span class="token parameter">aCourse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token function">removeCourse</span><span class="token punctuation">(</span><span class="token parameter">aCourse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-12"><a href="#动机-12" class="header-anchor">#</a> 动机</h3> <p>1、更改数据结构时更加方便；<br>
2、为类提供一些修改集合的方法————通常是“添加”和“移除”。</p> <h3 id="做法-12"><a href="#做法-12" class="header-anchor">#</a> 做法</h3> <p>1、如果集合的引用尚未背封装起来，先用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>封装它；<br>
2、在类上添加用于“添加集合元素”和“移除集合元素”的函数；</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果存在对该集合的设值函数，尽可能先用<a href="#%E7%A7%BB%E9%99%A4%E8%AE%BE%E5%80%BC%E5%87%BD%E6%95%B0-remove-setting-mehotd">移除设值函数</a>移除它。如果不能移除该设值函数，至少让它返回集合的一份副本。</p></div> <p>3、执行静态检查；<br>
4、查找集合的引用点。如果有调用者直接修改集合，令该处调用使用新得添加/移除元素的函数。每次修改后执行测试；<br>
5、修改集合的取值函数，使其返回一份只读的数据，可以使用只读代理或数据副本；<br>
6、测试。</p> <h2 id="移除设值函数-remove-setting-mehotd"><a href="#移除设值函数-remove-setting-mehotd" class="header-anchor">#</a> 移除设值函数(Remove Setting Mehotd)</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token parameter">aString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-13"><a href="#动机-13" class="header-anchor">#</a> 动机</h3> <p>1、不希望在对象创建之后此字段还有机会被改变；<br>
2、只能在构造函数中赋值；</p> <h3 id="做法-13"><a href="#做法-13" class="header-anchor">#</a> 做法</h3> <p>1、如果构造函数尚无法得到想要设入字段的值，就使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>将这个值以参数的形式传入构造函数。在构造函数中调用设值函数，对字段设值。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果想移除多个设值函数，可以一次性把它们的值都传入构造函数，这能简化后续步骤。</p></div> <p>2、移除所有在构造函数之外对设值函数的调用，改为使用新的构造函数。每次修改之后都要测试。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果不能把“调用设值函数”替换为“创建一个新对象”(例如你需要更新一个多处共享引用的对象)，请放弃本重构。</p></div> <p>3、使用<a href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0-inline-function">内联函数</a>消除设值函数。如果可能的话，把字段声明为不可变。<br>
4、测试。</p> <h2 id="以对象取代基本类型-replace-primitive-with-object"><a href="#以对象取代基本类型-replace-primitive-with-object" class="header-anchor">#</a> 以对象取代基本类型(Replace Primitive with Object)</h2> <p>曾用名：以对象取代数据值、以类取代类型码</p> <div class="language-js extra-class"><pre class="language-js"><code>  orders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;high&quot;</span> <span class="token operator">===</span> o<span class="token punctuation">.</span>priority <span class="token operator">||</span> <span class="token string">&quot;rush&quot;</span> <span class="token operator">===</span> o<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  orders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>priority<span class="token punctuation">.</span><span class="token function">higherThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Priority</span><span class="token punctuation">(</span><span class="token string">&quot;normal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="动机-14"><a href="#动机-14" class="header-anchor">#</a> 动机</h3> <p>1、对某个数据的操作不仅仅局限于打印时，可以为它创建一个新类；<br>
2、只要类有了，日后添加的业务逻辑就有地方可以去了。</p> <h3 id="做法-14"><a href="#做法-14" class="header-anchor">#</a> 做法</h3> <p>1、如果变量尚未被封装起来，先使用<a href="#%E5%B0%81%E8%A3%85%E5%8F%98%E9%87%8F-encapsulate-variable">封装变量</a>封装它；<br>
2、为这个数据值创建一个简单的类。类的构造函数应该保存这个数据值，并未它提供一个取值函数；<br>
3、执行静态检查；<br>
4、修改第一步得到的设置函数，令其创建一个新类的对象并将其存入字段，如果有必要的话，同时修改字段的类型声明；<br>
5、修改取值函数，令其调用新类的取值函数，并返回结果；<br>
6、测试；<br>
7、考虑对第一步得到的访问函数使用<a href="#%E6%94%B9%E5%8F%98%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-change-function-declaration">改变函数声明</a>，以便更好反映其用途；<br>
8、考虑应用<a href="">将引用对象改为值对象</a>或<a href="">将值对象改为引用对象</a>，明确指出新对象的角色是值对象还是引用对象</p> <h2 id="将引用对象改为值对象-change-reference-to-value"><a href="#将引用对象改为值对象-change-reference-to-value" class="header-anchor">#</a> 将引用对象改为值对象(Change Reference to Value)</h2> <p>反向重构：将值对象改为引用对象</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token function">applyDiscount</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>amount <span class="token operator">-=</span> arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token function">applyDiscount</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_price <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>amount <span class="token operator">-</span> arg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_price<span class="token punctuation">.</span>currency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="动机-15"><a href="#动机-15" class="header-anchor">#</a> 动机</h3> <p>如果想在几个对象之间共享一个对象，以便几个对象都能看到对共享对象的修改，那么这个共享的对象就应该是引用。</p> <h3 id="做法-15"><a href="#做法-15" class="header-anchor">#</a> 做法</h3> <p>1、检查重构目标是否为不可变对象，或者是否为可修改为不可变对象；<br>
2、用<a href="#%E7%A7%BB%E9%99%A4%E8%AE%BE%E5%80%BC%E5%87%BD%E6%95%B0-remove-setting-mehotd">移除设值函数</a>逐一去掉所有设值函数；<br>
3、提供一个基于值得相等性判断函数，在其中使用值对象得字段。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>大多数编程语言都提供了可覆写的相等性判断函数。通常你还必须同时覆写生成散列码的函数。</p></div> <h2 id="将值对象改为引用对象-change-value-to-reference"><a href="#将值对象改为引用对象-change-value-to-reference" class="header-anchor">#</a> 将值对象改为引用对象(Change Value to Reference)</h2> <p>反向重构：将引用对象改为值对象</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> customer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Costomer</span><span class="token punctuation">(</span>customerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> customer <span class="token operator">=</span> customerRepository<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>customerData<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="动机-16"><a href="#动机-16" class="header-anchor">#</a> 动机</h3> <hr> <h3 id="做法-16"><a href="#做法-16" class="header-anchor">#</a> 做法</h3> <p>1、为相关对象创建一个仓库（如果没有这样一个仓库的话）；<br>
2、确保构造函数有办法找到对象的正确实例；<br>
3、修改宿主对象的构造函数，令其从仓库中获取关联对象。每次修改后执行测试。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/chore/bad-smell.html" class="prev">
        代码的怪味道
      </a></span> <span class="next"><a href="/book/chore/good-words.html">
        好句子
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d23418ae.js" defer></script><script src="/assets/js/2.eab5a6f5.js" defer></script><script src="/assets/js/26.c86453be.js" defer></script>
  </body>
</html>
